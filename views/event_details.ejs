<% if (!error) { %>
<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="display-4 fw-bold text-dark me-3 event-title-wrap">
        <%= event.title %>
      </h1>
      <span class="badge bg-secondary p-2 fs-6 shadow-sm">
        <i class="fas fa-eye me-1"></i> Görüntülenme: <%= event.numOfViews %>
      </span>
    </div>

    <div class="row g-4">
      <div class="col-lg-4 order-lg-2">
        <div class="card shadow-lg mb-4 border-0">
          <img
            src="<%= event.imagePath || '/static/img/default-event.png' %>"
            class="card-img-top rounded-top"
            alt="<%= event.title %> Görseli"
            style="height: 220px; object-fit: cover"
          />

          <div class="card-body">
            <h6 class="card-subtitle mb-3 text-muted">
              <i class="fas fa-calendar-alt me-1 text-primary"></i>
              <%= new Date(event.date).toLocaleDateString('tr-TR', { year:
              'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute:
              '2-digit' }) %>
              <br />
              <i class="fas fa-map-marker-alt me-1 text-success"></i>
              <%= event.location %>
            </h6>

            <p class="mb-3">
              <span class="fw-bold">Kontenjan:</span>
              <span class="badge bg-info"
                ><%= numOfParticipants %> / <%= event.quota %> Kişi</span
              >
            </p>

            <div class="d-grid">
              <% if (isAuthenticated) { %> <% if (isRegistered) { %>
              <button class="btn btn-success btn-lg" disabled>
                <i class="fas fa-check-circle me-1"></i> Kaydınız Tamamlandı!
              </button>
              <% } else if (event.quota > numOfParticipants) { %>
              <form action="/user/register-event/<%= event.id %>" method="POST">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <input
                  type="hidden"
                  name="eventSlug"
                  value="<%= event.slug %>"
                />
                <button type="submit" class="btn btn-primary btn-lg w-100">
                  <i class="fas fa-user-plus me-1"></i> Etkinliğe Kayıt Ol
                </button>
              </form>
              <% } else { %>
              <button class="btn btn-danger btn-lg" disabled>
                <i class="fas fa-times-circle me-1"></i> Kontenjan Doldu
              </button>
              <% } %> <% } else { %>
              <a href="/login" class="btn btn-secondary btn-lg">
                Kayıt Olmak İçin Giriş Yapın
              </a>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-8 order-lg-1">
        <h3 class="mb-3 fw-bold text-primary">Açıklama</h3>
        <div class="p-3 mb-4 rounded bg-light border">
          <div class="description-content" style="white-space: pre-wrap">
            <p class="mb-0"><%= event.desc %></p>
          </div>
        </div>

        <h3 class="mt-5 mb-3 fw-bold text-primary">
          Soru ve Cevaplar (<%= event.eventQuestions ?
          event.eventQuestions.length : 0 %>)
        </h3>
        <div class="card shadow-sm">
          <div class="card-body">
            <% if (isAuthenticated) { %>
            <form
              action="/events/<%= event.slug %>/comment"
              method="POST"
              class="mb-4 border-bottom pb-3"
            >
              <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
              <div class="mb-3">
                <textarea
                  class="form-control"
                  name="questionText"
                  rows="2"
                  placeholder="Etkinlik hakkında bir soru sorun..."
                  required
                ></textarea>
              </div>
              <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-sm btn-outline-primary">
                  Gönder
                </button>
              </div>
            </form>
            <% } else { %>
            <div class="alert alert-info text-center" role="alert">
              Yorum/Soru göndermek için lütfen
              <a href="/login" class="alert-link">Giriş Yapın</a>.
            </div>
            <% } %>

            <div class="comment-list">
              <% if (event.eventQuestions && event.eventQuestions.length > 0) {
              %> <% event.eventQuestions.forEach(q => { %>
              <div class="d-flex mb-3 border-bottom pb-2">
                <div class="flex-shrink-0 me-3">
                  <i class="fas fa-user-circle fa-2x text-secondary"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="fw-bold">
                    <%= q.asker.username %>
                    <small class="text-muted ms-2"
                      ><%= new Date(q.createdAt).toLocaleDateString() %>
                    </small>
                  </div>
                  <p class="mb-1"><%= q.questionText %></p>

                  <% if (q.answerText) { %>
                  <div class="alert alert-success py-1 px-2 mt-2" role="alert">
                    <i class="fas fa-reply me-1"></i>
                    <span class="fw-bold">Cevap:</span> <%= q.answerText %>
                  </div>
                  <% } %>
                </div>
              </div>
              <% }); %> <% } else { %>
              <p class="text-center text-muted">
                Bu etkinlik için henüz bir soru sorulmamıştır.
              </p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% } %> <%if (error) { %>
<div class="alert alert-danger text-center" role="alert">
  <i class="fas fa-exclamation-triangle me-2"></i> <%= error %>
</div>
<% } %>
